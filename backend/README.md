# é“è§‚æœåŠ¡é¢„çº¦ç³»ç»Ÿ - åç«¯ API æ–‡æ¡£

## é¡¹ç›®è¯´æ˜

è¿™æ˜¯é“è§‚æœåŠ¡é¢„çº¦å°ç¨‹åºçš„åç«¯ API æœåŠ¡,ä½¿ç”¨ Express.js æ„å»ºã€‚

## Mock æ•°æ®åº“æ¨¡å¼

ä¸ºäº†æ–¹ä¾¿å¼€å‘æµ‹è¯•,é¡¹ç›®æ”¯æŒæ— éœ€å®‰è£… MySQL çš„ Mock æ•°æ®åº“æ¨¡å¼:

- ä½¿ç”¨å†…å­˜å­˜å‚¨æ‰€æœ‰æ•°æ®
- å·²é¢„ç½®åˆ†ç±»å’ŒæœåŠ¡æ•°æ®
- æ‰€æœ‰ API æ¥å£å‡å¯æ­£å¸¸ä½¿ç”¨
- é€‚åˆå‰ç«¯å¼€å‘å’ŒåŠŸèƒ½æµ‹è¯•

### é…ç½®è¯´æ˜

åœ¨ `.env` æ–‡ä»¶ä¸­è®¾ç½®:
```
USE_MOCK=true    # ä½¿ç”¨ Mock æ¨¡å¼(æ— éœ€ MySQL)
USE_MOCK=false   # ä½¿ç”¨çœŸå® MySQL æ•°æ®åº“
```

## å¯åŠ¨æœåŠ¡

```bash
# å®‰è£…ä¾èµ–
npm install

# å¼€å‘æ¨¡å¼(çƒ­é‡è½½)
npm run dev

# ç”Ÿäº§æ¨¡å¼
npm start
```

æœåŠ¡é»˜è®¤è¿è¡Œåœ¨: `http://localhost:3000`

## API æ¥å£æ–‡æ¡£

### 1. å¥åº·æ£€æŸ¥

**æ¥å£**: `GET /health`

**è¯´æ˜**: æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ

**å“åº”ç¤ºä¾‹**:
```json
{
  "status": "ok",
  "message": "é“è§‚æœåŠ¡APIè¿è¡Œä¸­"
}
```

---

### 2. åˆ†ç±»ç®¡ç†

#### 2.1 è·å–åˆ†ç±»åˆ—è¡¨

**æ¥å£**: `GET /api/categories`

**è¯´æ˜**: è·å–æ‰€æœ‰å¯ç”¨çš„æœåŠ¡åˆ†ç±»

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "æ³•äº‹æœåŠ¡",
      "icon": "ğŸ™",
      "sort_order": 1,
      "status": "active",
      "created_at": "2026-02-13T02:13:58.200Z",
      "updated_at": "2026-02-13T02:13:58.200Z"
    },
    {
      "id": 2,
      "name": "ç¥ˆç¦æœåŠ¡",
      "icon": "âœ¨",
      "sort_order": 2,
      "status": "active",
      "created_at": "2026-02-13T02:13:58.200Z",
      "updated_at": "2026-02-13T02:13:58.200Z"
    }
  ]
}
```

#### 2.2 è·å–åˆ†ç±»è¯¦æƒ…

**æ¥å£**: `GET /api/categories/:id`

**å‚æ•°**:
- `id`: åˆ†ç±»ID

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "æ³•äº‹æœåŠ¡",
    "icon": "ğŸ™",
    "sort_order": 1,
    "status": "active"
  }
}
```

---

### 3. æœåŠ¡ç®¡ç†

#### 3.1 è·å–æœåŠ¡åˆ—è¡¨

**æ¥å£**: `GET /api/services`

**æŸ¥è¯¢å‚æ•°**:
- `category_id` (å¯é€‰): æŒ‰åˆ†ç±»ç­›é€‰

**ç¤ºä¾‹**:
- è·å–æ‰€æœ‰æœåŠ¡: `GET /api/services`
- è·å–æŒ‡å®šåˆ†ç±»: `GET /api/services?category_id=1`

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "ç¥ˆç¦æ³•äº‹",
      "short_description": "ä¸ºæ‚¨å’Œå®¶äººç¥ˆæ±‚å¹³å®‰å¥åº·ï¼Œæ¶ˆç¾è§£å„",
      "description": "ç¥ˆç¦æ³•äº‹æ˜¯é“æ•™ä¼ ç»Ÿä»ªå¼...",
      "category_id": 1,
      "category_name": "æ³•äº‹æœåŠ¡",
      "base_price": 200,
      "price_per_person": 50,
      "image_url": "",
      "sort_order": 1,
      "status": "active"
    }
  ]
}
```

#### 3.2 è·å–æœåŠ¡è¯¦æƒ…

**æ¥å£**: `GET /api/services/:id`

**å‚æ•°**:
- `id`: æœåŠ¡ID

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "ç¥ˆç¦æ³•äº‹",
    "short_description": "ä¸ºæ‚¨å’Œå®¶äººç¥ˆæ±‚å¹³å®‰å¥åº·ï¼Œæ¶ˆç¾è§£å„",
    "description": "ç¥ˆç¦æ³•äº‹æ˜¯é“æ•™ä¼ ç»Ÿä»ªå¼ï¼Œé€šè¿‡è¯µç»ã€ç„šé¦™ã€ä¾›å¥‰ç­‰æ–¹å¼...",
    "category_id": 1,
    "category_name": "æ³•äº‹æœåŠ¡",
    "base_price": 200,
    "price_per_person": 50,
    "image_url": "",
    "sort_order": 1,
    "status": "active"
  }
}
```

---

### 4. è®¢å•ç®¡ç†

#### 4.1 åˆ›å»ºè®¢å•

**æ¥å£**: `POST /api/orders`

**è¯·æ±‚ä½“**:
```json
{
  "user_id": "test_user_123",
  "service_id": 1,
  "persons": [
    {
      "name": "å¼ ä¸‰",
      "gender": "male",
      "birth_date": "1990-05-15",
      "shichen_value": 3,
      "address": "åŒ—äº¬å¸‚æœé˜³åŒº"
    }
  ],
  "remark": "ç¥ˆæ±‚å¹³å®‰"
}
```

**å‚æ•°è¯´æ˜**:
- `user_id`: ç”¨æˆ·ID(å¾®ä¿¡openid)
- `service_id`: æœåŠ¡ID
- `persons`: äººå‘˜ä¿¡æ¯æ•°ç»„
  - `name`: å§“å
  - `gender`: æ€§åˆ« (male/female)
  - `birth_date`: å‡ºç”Ÿæ—¥æœŸ (YYYY-MM-DD)
  - `shichen_value`: æ—¶è¾°å€¼ (0-11æ­£å¸¸æ—¶è¾°, 99è¡¨ç¤ºå‰æ—¶æœªçŸ¥)
  - `address`: å±…ä½åœ°å€
- `remark`: å¤‡æ³¨è¯´æ˜

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "è®¢å•åˆ›å»ºæˆåŠŸ",
  "data": {
    "order_id": 1,
    "order_no": "DD17709489883424S3W1H71M",
    "total_amount": 250,
    "person_count": 1
  }
}
```

#### 4.2 è·å–è®¢å•åˆ—è¡¨

**æ¥å£**: `GET /api/orders?user_id=xxx`

**æŸ¥è¯¢å‚æ•°**:
- `user_id`: ç”¨æˆ·ID (å¿…å¡«)

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "order_no": "DD17709489883424S3W1H71M",
      "user_id": "test_user_123",
      "service_id": 1,
      "service_name": "ç¥ˆç¦æ³•äº‹",
      "service_image": "",
      "total_amount": 250,
      "person_count": 1,
      "status": "pending",
      "payment_status": "unpaid",
      "created_at": "2026-02-13T02:16:28.342Z"
    }
  ]
}
```

**è®¢å•çŠ¶æ€è¯´æ˜**:
- `status`: pending(å¾…å¤„ç†), paid(å·²æ”¯ä»˜), processing(å¤„ç†ä¸­), completed(å·²å®Œæˆ), cancelled(å·²å–æ¶ˆ)
- `payment_status`: unpaid(æœªæ”¯ä»˜), paid(å·²æ”¯ä»˜), refunded(å·²é€€æ¬¾)

#### 4.3 è·å–è®¢å•è¯¦æƒ…

**æ¥å£**: `GET /api/orders/:id`

**å‚æ•°**:
- `id`: è®¢å•ID

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "order_no": "DD17709489883424S3W1H71M",
    "user_id": "test_user_123",
    "service_id": 1,
    "service_name": "ç¥ˆç¦æ³•äº‹",
    "service_description": "ä¸ºæ‚¨å’Œå®¶äººç¥ˆæ±‚å¹³å®‰å¥åº·ï¼Œæ¶ˆç¾è§£å„",
    "total_amount": 250,
    "person_count": 1,
    "status": "pending",
    "payment_status": "unpaid",
    "remark": "ç¥ˆæ±‚å¹³å®‰",
    "created_at": "2026-02-13T02:16:28.342Z",
    "persons": [
      {
        "id": 1,
        "name": "å¼ ä¸‰",
        "gender": "male",
        "birth_date": "1990-05-15",
        "shichen_value": 3,
        "shichen_name": "å¯æ—¶ï¼ˆ05:00-07:00ï¼‰",
        "bazi_year": "åºšåˆ",
        "bazi_month": "è¾›å·³",
        "bazi_day": "åºšè¾°",
        "bazi_hour": "åºšè¾°",
        "bazi_full": "åºšåˆ è¾›å·³ åºšè¾° åºšè¾°",
        "wuxing_year": "é‡‘ç«",
        "wuxing_month": "é‡‘ç«",
        "wuxing_day": "é‡‘åœŸ",
        "wuxing_hour": "é‡‘åœŸ",
        "shengxiao": "é©¬",
        "lunar_date": "ä¸€ä¹ä¹ã€‡å¹´å››æœˆå»¿ä¸€",
        "address": "åŒ—äº¬å¸‚æœé˜³åŒº"
      }
    ]
  }
}
```

---

### 5. æ—¶è¾°æŸ¥è¯¢

#### 5.1 è·å–æ—¶è¾°åˆ—è¡¨

**æ¥å£**: `GET /api/shichen`

**è¯´æ˜**: è·å–æ‰€æœ‰å¯é€‰æ—¶è¾°

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "name": "å­æ—¶ï¼ˆ23:00-01:00ï¼‰",
      "value": 0,
      "earthlyBranch": "å­",
      "displayName": "å­æ—¶"
    },
    {
      "name": "ä¸‘æ—¶ï¼ˆ01:00-03:00ï¼‰",
      "value": 1,
      "earthlyBranch": "ä¸‘",
      "displayName": "ä¸‘æ—¶"
    },
    ...
    {
      "name": "å‰æ—¶ï¼ˆæ—¶è¾°æœªçŸ¥ï¼‰",
      "value": 99,
      "earthlyBranch": "å‰",
      "displayName": "å‰æ—¶"
    }
  ]
}
```

---

## é¢„ç½®æ•°æ®

### åˆ†ç±»æ•°æ®

Mock æ¨¡å¼ä¸‹å·²é¢„ç½® 3 ä¸ªåˆ†ç±»:
1. æ³•äº‹æœåŠ¡ ğŸ™
2. ç¥ˆç¦æœåŠ¡ âœ¨
3. å‰ç¥¥ç‰©å“ ğŸ

### æœåŠ¡æ•°æ®

Mock æ¨¡å¼ä¸‹å·²é¢„ç½® 6 ä¸ªæœåŠ¡:
1. ç¥ˆç¦æ³•äº‹ - åŸºç¡€ä»· Â¥200, æ¯äººåŠ ä»· Â¥50
2. è¶…åº¦æ³•äº‹ - åŸºç¡€ä»· Â¥300, æ¯äººåŠ ä»· Â¥80
3. å§»ç¼˜ç¥ˆç¦ - åŸºç¡€ä»· Â¥180, æ¯äººåŠ ä»· Â¥40
4. äº‹ä¸šç¥ˆç¦ - åŸºç¡€ä»· Â¥180, æ¯äººåŠ ä»· Â¥40
5. å¹³å®‰ç¬¦ - åŸºç¡€ä»· Â¥100, æ¯äººåŠ ä»· Â¥30
6. å¥åº·ç¥ˆç¦ - åŸºç¡€ä»· Â¥150, æ¯äººåŠ ä»· Â¥40

---

## å…«å­—è®¡ç®—è¯´æ˜

ç³»ç»Ÿä½¿ç”¨ `lunar-javascript` åº“è‡ªåŠ¨è®¡ç®—å…«å­—ä¿¡æ¯:

- **è¾“å…¥**: å‡ºç”Ÿæ—¥æœŸ + æ—¶è¾°å€¼
- **è¾“å‡º**:
  - å®Œæ•´å…«å­—(å¹´æŸ±ã€æœˆæŸ±ã€æ—¥æŸ±ã€æ—¶æŸ±)
  - äº”è¡Œå±æ€§
  - ç”Ÿè‚–
  - å†œå†æ—¥æœŸ

**ç‰¹æ®Šå¤„ç†**: å½“æ—¶è¾°æœªçŸ¥æ—¶(shichen_value = 99),ç³»ç»Ÿä½¿ç”¨"å‰æ—¶"æ ‡è®°,ä»…è®¡ç®—å¹´æœˆæ—¥æŸ±ã€‚

---

## æµ‹è¯•å‘½ä»¤

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3000/health

# è·å–åˆ†ç±»
curl http://localhost:3000/api/categories

# è·å–æœåŠ¡
curl http://localhost:3000/api/services

# è·å–æŒ‡å®šåˆ†ç±»çš„æœåŠ¡
curl "http://localhost:3000/api/services?category_id=1"

# åˆ›å»ºè®¢å•
curl -X POST http://localhost:3000/api/orders \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "test_user_123",
    "service_id": 1,
    "persons": [{
      "name": "å¼ ä¸‰",
      "gender": "male",
      "birth_date": "1990-05-15",
      "shichen_value": 3,
      "address": "åŒ—äº¬å¸‚æœé˜³åŒº"
    }],
    "remark": "ç¥ˆæ±‚å¹³å®‰"
  }'

# è·å–è®¢å•åˆ—è¡¨
curl "http://localhost:3000/api/orders?user_id=test_user_123"

# è·å–è®¢å•è¯¦æƒ…
curl http://localhost:3000/api/orders/1

# è·å–æ—¶è¾°åˆ—è¡¨
curl http://localhost:3000/api/shichen
```

---

## æ³¨æ„äº‹é¡¹

1. **Mock æ¨¡å¼**: æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­,æœåŠ¡é‡å¯åæ•°æ®ä¼šä¸¢å¤±
2. **å­—ç¬¦ç¼–ç **: ç¡®ä¿å®¢æˆ·ç«¯ä½¿ç”¨ UTF-8 ç¼–ç 
3. **é”™è¯¯å¤„ç†**: æ‰€æœ‰æ¥å£éƒ½ä¼šè¿”å›æ ‡å‡†æ ¼å¼çš„é”™è¯¯ä¿¡æ¯
4. **è·¨åŸŸ**: å·²å¯ç”¨ CORS,æ”¯æŒå‰ç«¯è·¨åŸŸè¯·æ±‚

---

## æœªæ¥æ‰©å±•

- [ ] æ”¯ä»˜æ¥å£é›†æˆ(å¾®ä¿¡æ”¯ä»˜)
- [ ] ç”¨æˆ·è®¤è¯æ¥å£(å¾®ä¿¡ç™»å½•)
- [ ] ç®¡ç†åå°æ¥å£
- [ ] æ–‡ä»¶ä¸Šä¼ (æœåŠ¡å›¾ç‰‡)
- [ ] è®¢å•çŠ¶æ€æ›´æ–°æ¨é€

---

## æŠ€æœ¯æ ˆ

- Node.js
- Express.js
- MySQL2 (çœŸå®æ¨¡å¼)
- lunar-javascript (å…«å­—è®¡ç®—)
- dotenv (ç¯å¢ƒé…ç½®)

---

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜,è¯·æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚
